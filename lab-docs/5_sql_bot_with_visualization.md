# Support for SQL Bot with Visualization

Let's try to add the capability to visualize the data generated by the SQL query.

## Create `SQLBotWithVisualization`

You can simply copy the `sql_chatbot_with_data_insights` to `sql_chatbot_with_visualization.py` and update the `create_answer` function to add a visualization router:

```python
    @staticmethod
    def should_visualize(user_query):
        prompt = f"""You are a helpful assistant to decide if a user's request needs visualization or not.

Given the user query={user_query}. tell me if it asks to visualize the data.
When user ask for visualization/plotting related. such as please visualize ..., give me a line chart, etc. output yes, otherwise output no.
Don't output anything other than yes or no. if you are not sure return no.
Output:"""
        response = get_openai_output(prompt, max_tokens=10)

        if 'yes' in response.lower():
            return True
        return False
```

We call it router because it will decide if the user query needs visualization or not. If it needs visualization, we will call the `visualize` function, otherwise we will call the `generate` function.

As you may notice, it uses the OpenAI API to decide if the user query needs visualization or not. You can replace it with your own logic.

## Add the visualization function

```python

    def create_answer(self, user_query):
        visualize = self.should_visualize(user_query)
        
        ...

        if visualize:
            plot = waii.query.plot(
                df,
                ask=user_query + ". Make sure that you use 'st.plotly_chart(fig, use_container_width=True)'. You can only import streamlit, pandas, plotly and plotly.express'",
                verbose=False,
                automatically_exec=False)
            output_message = AssistantMessage(content=(df, plot), type=AssistantMessageType.Plot)
        else:
            output_message = AssistantMessage(content=df, type=AssistantMessageType.Data)

        insights = self.get_data_insights(user_query, df)

        # display with formatting (sql, steps, data)
        display_answer(AssistantOutput(messages=[
            output_message,
            AssistantMessage(content=insights, type=AssistantMessageType.TextStream),
        ]), 'assistant', True)
```

We use the `should_visualize` function to decide if the user query needs visualization or not. If it needs visualization, we call the `plot` function from the WAII SDK to generate the plot.

## Final code

You can find the final code in the `sql_chatbot_with_visualization.py` file.

## Bonus tasks: 

### Add capability to create multiple plots

This is a bonus task, now every time we only generate one plot. You can extend the capability to generate multiple plots.

### Grounding the bot's answers

You can try to ask the bot to return some questions which outside of the data. For example, you can ask the bot to return how to make fried rice. The bot should return that it can only answer questions related to the data.

Can you try to implement this? (Hint: you can use the similar "routing" logic to decide if the user query is related to the data or not.)

### Add capability to breakdown a single question into multiple questions

It is possible that one user's ask should be broken down into multiple questions. For example, if the user asks "give me best selling movies, and most popular actors", the bot should break it down into two questions: "give me best selling movies" and "give me most popular actors".

Can you try to implement this? (Hint: you can create a "routing" function to decide if the user query should be broken down or not. If it should be broken down, you can call the `create_answer` function multiple times.)